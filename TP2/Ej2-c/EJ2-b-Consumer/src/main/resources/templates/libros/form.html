<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title th:text="${entity.id != null ? 'Editar Libro' : 'Nuevo Libro'}">Libro</title>
</head>

<div layout:fragment="content">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                <li class="breadcrumb-item"><a href="/libros">Libros</a></li>
                <li class="breadcrumb-item active"
                    th:text="${entity.id != null ? 'Editar' : 'Nuevo Libro'}">Formulario</li>
            </ol>
        </nav>

        <div class="row mb-4">
            <div class="col-md-8">
                <h1>
                    <i th:class="${entity.id != null ? 'bi bi-pencil-square text-warning' : 'bi bi-bookmark-plus text-primary'}"></i>
                    <span th:text="${entity.id != null ? 'Editar Libro' : 'Registrar Libro'}">Formulario de Libro</span>
                </h1>
                <p class="text-muted"
                   th:text="${entity.id != null ? 'Actualiza los datos del libro seleccionado' : 'Completa la información para registrar un nuevo libro'}">
                    Información del libro
                </p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/libros" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al listado
                </a>
            </div>
        </div>

        <div th:replace="~{fragments/messages :: messages}"></div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header"
                         th:classappend="${entity.id != null ? 'bg-warning text-dark' : 'bg-primary text-white'}">
                        <h5 class="mb-0">
                            <i th:class="${entity.id != null ? 'bi bi-pencil' : 'bi bi-book'}"></i>
                            <span th:text="${entity.id != null ? 'Datos del Libro' : 'Nuevo Libro'}">Datos del Libro</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="${entity.id != null ? '/libros/actualizar/' + entity.id : '/libros/crear'}"
                              method="post"
                              th:object="${entity}"
                              enctype="multipart/form-data"
                              autocomplete="off">

                            <input type="hidden" th:field="*{id}" th:if="${entity.id != null}">
                            <input type="hidden" th:field="*{eliminado}">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="titulo" class="form-label">
                                        <i class="bi bi-bookmark text-primary"></i> Título <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           id="titulo"
                                           class="form-control"
                                           th:field="*{titulo}"
                                           th:classappend="${#fields.hasErrors('titulo')} ? ' is-invalid' : ''"
                                           placeholder="Ingrese el título"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}">
                                        Error en el título
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="genero" class="form-label">
                                        <i class="bi bi-tags text-success"></i> Género <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           id="genero"
                                           class="form-control"
                                           th:field="*{genero}"
                                           th:classappend="${#fields.hasErrors('genero')} ? ' is-invalid' : ''"
                                           placeholder="Ej: Novela, Ensayo, Ciencia ficción"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('genero')}" th:errors="*{genero}">
                                        Error en el género
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label for="paginas" class="form-label">
                                        <i class="bi bi-list-ol text-info"></i> Número de páginas <span class="text-danger">*</span>
                                    </label>
                                    <input type="number"
                                           id="paginas"
                                           class="form-control"
                                           th:field="*{paginas}"
                                           min="1"
                                           th:classappend="${#fields.hasErrors('paginas')} ? ' is-invalid' : ''"
                                           placeholder="0"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('paginas')}" th:errors="*{paginas}">
                                        Error en la cantidad de páginas
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label for="fecha" class="form-label">
                                        <i class="bi bi-calendar-event text-warning"></i> Fecha de publicación
                                    </label>
                                    <input type="date"
                                           id="fecha"
                                           class="form-control"
                                           th:field="*{fecha}">
                                </div>

                                <div class="col-md-4">
                                    <label for="persona" class="form-label">
                                        <i class="bi bi-person-check text-success"></i> Prestado a
                                    </label>
                                    <select id="persona" class="form-select" th:field="*{persona}">
                                        <option value="">Disponible</option>
                                        <option th:each="persona : ${personasDisponibles}"
                                                th:value="${persona.id}"
                                                th:text="${persona.nombre + ' ' + persona.apellido}">
                                            Persona
                                        </option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label for="autores" class="form-label">
                                        <i class="bi bi-people text-primary"></i> Autores <span class="text-danger">*</span>
                                    </label>
                                    <select id="autores"
                                            class="form-select"
                                            multiple
                                            size="6"
                                            th:field="*{autores}"
                                            th:classappend="${#fields.hasErrors('autores')} ? ' is-invalid' : ''">
                                        <option th:each="autor : ${autoresDisponibles}"
                                                th:value="${autor.id}"
                                                th:text="${autor.nombre + ' ' + autor.apellido}">
                                            Autor disponible
                                        </option>
                                    </select>
                                    <div class="form-text">Mantén presionada la tecla Ctrl (Cmd en Mac) para seleccionar múltiples autores.</div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('autores')}" th:errors="*{autores}">
                                        Debes seleccionar al menos un autor
                                    </div>
                                </div>

                                <!-- Campo PDF para crear nuevo libro -->
                                <div class="col-12" th:if="${entity.id == null}">
                                    <label for="archivoPDF" class="form-label">
                                        <i class="bi bi-file-pdf text-danger"></i> Documento PDF
                                    </label>
                                    <input type="file"
                                           id="archivoPDF"
                                           name="archivoPDF"
                                           class="form-control"
                                           accept="application/pdf">
                                    <div class="form-text">Selecciona un archivo PDF para asociarlo con este libro (opcional).</div>
                                </div>

                                <!-- Gestión de PDF para editar libro existente -->
                                <div class="col-12" th:if="${entity.id != null}">
                                    <label class="form-label">
                                        <i class="bi bi-file-pdf text-danger"></i> Documento PDF
                                    </label>
                                    
                                    <!-- Mostrar PDF actual si existe -->
                                    <div th:if="${entity.documento != null}" class="alert alert-info d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <i class="bi bi-file-earmark-pdf text-danger"></i>
                                            <strong>PDF actual:</strong> <span th:text="${entity.documento.nombreArchivo}">archivo.pdf</span>
                                        </div>
                                        <a th:href="@{/api/v1/documentos/download/{id}(id=${entity.documento.id})}" 
                                           target="_blank" 
                                           class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye"></i> Ver PDF
                                        </a>
                                    </div>
                                    
                                    <div th:unless="${entity.documento != null}" class="alert alert-warning mb-2">
                                        <i class="bi bi-exclamation-triangle"></i> Este libro no tiene un PDF asociado
                                    </div>
                                    
                                    <!-- Input para reemplazar PDF -->
                                    <input type="file"
                                           id="archivoPDF"
                                           name="archivoPDF"
                                           class="form-control"
                                           accept="application/pdf">
                                    <div class="form-text" th:if="${entity.documento != null}">
                                        Selecciona un nuevo archivo para <strong>reemplazar</strong> el PDF actual.
                                    </div>
                                    <div class="form-text" th:unless="${entity.documento != null}">
                                        Selecciona un archivo PDF para asociarlo con este libro.
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="submit" class="btn"
                                            th:classappend="${entity.id != null ? ' btn-warning' : ' btn-primary'}">
                                        <i th:class="${entity.id != null ? 'bi bi-check-circle' : 'bi bi-plus-circle'}"></i>
                                        <span th:text="${entity.id != null ? 'Actualizar Libro' : 'Registrar Libro'}">Guardar</span>
                                    </button>
                                    <a href="/libros" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </a>
                                </div>
                                <div th:if="${entity.id != null}">
                                    <form th:action="@{/libros/{id}/eliminar(id=${entity.id})}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-danger">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-info-circle text-info"></i> Consejos
                        </h6>
                    </div>
                    <div class="card-body small">
                        <ul class="mb-0">
                            <li><strong>Título y Género:</strong> obligatorios para identificar el libro.</li>
                            <li><strong>Autores:</strong> selecciona al menos uno para mantener la autoría actualizada.</li>
                            <li><strong>Prestado a:</strong> déjalo en "Disponible" si el libro está en biblioteca.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div layout:fragment="scripts">
    <script>
        const tituloInput = document.getElementById('titulo');
        if (tituloInput) {
            tituloInput.addEventListener('blur', function () {
                this.value = this.value.trim();
            });
        }
    </script>
</div>
</html>
