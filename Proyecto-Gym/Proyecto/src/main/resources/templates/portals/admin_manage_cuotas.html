<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	<head th:replace="~{components/header :: head}"></head>
	<body>

		<div th:replace="~{components/admin_subnav :: admin_nav}"></div>

		<div class="container py-5" th:with="entityName='Cuotas', items=${items}">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2>ABM Cuotas</h2>
				<div>
					<button class="btn btn-success" id="btnNew">Nueva Cuota</button>
					<a class="btn btn-secondary" th:href="@{/portal/admin}">Volver al portal</a>
				</div>
			</div>

			<div class="table-responsive">
				<table class="table table-striped" id="abmTable">
					<thead>
						<tr>
							<th>#</th>
							<th>Mes</th>
							<th>Año</th>
							<th>Vencimiento</th>
							<th>Valor Cuota</th>
							<th>Estado</th>
							<th>Eliminado</th>
							<th>Acciones</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item : ${items}">
							<td th:text="${item.id}">id</td>
							<td th:text="${item.mes}">ENERO</td>
							<td th:text="${item.anio}">2025</td>
							<td th:text="${item.fechaVencimiento}">2025-01-31</td>
							<td th:text="${item.valorCuota != null ? item.valorCuota.valor : 'N/A'}">1000</td>
							<td th:text="${item.estado}">PENDIENTE</td>
							<td><span th:text="${item.eliminado} ? 'Sí' : 'No'">No</span></td>
							<td>
								<button class="btn btn-sm btn-primary btn-edit" type="button"
												th:data-id="${item.id}" th:data-mes="${item.mes}" th:data-anio="${item.anio}" th:data-fechav="${item.fechaVencimiento}"
												th:data-valor="${item.valorCuota != null ? item.valorCuota.id : ''}" th:data-estado="${item.estado}" th:data-eliminado="${item.eliminado}">Editar</button>
								<button class="btn btn-sm btn-danger btn-delete" type="button" th:data-id="${item.id}">Eliminar</button>
							</td>
						</tr>
						<tr th:if="${items == null or #lists.isEmpty(items)}">
							<td colspan="8" class="text-center">No hay cuotas cargadas.</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- Modal: Cuota -->
			<div class="modal fade" id="abmModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="abmModalTitle">Nueva Cuota</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<form id="abmForm">
								<input type="hidden" id="itemId" name="id" />
								<div class="row">
									<div class="col-md-6 mb-3">
										<label class="form-label">Mes</label>
										<input id="itemMes" name="mes" class="form-control" />
									</div>
									<div class="col-md-6 mb-3">
										<label class="form-label">Año</label>
										<input id="itemAnio" name="anio" class="form-control" type="number" />
									</div>
								</div>
								<div class="mb-3">
									<label class="form-label">Fecha Vencimiento</label>
									<input id="itemFechaV" name="fechaVencimiento" class="form-control" type="date" />
								</div>
								<div class="mb-3">
									<label class="form-label">Valor Cuota (ID)</label>
									<input id="itemValor" name="valorCuotaId" class="form-control" />
								</div>
								<div class="mb-3">
									<label class="form-label">Estado</label>
									<input id="itemEstado" name="estado" class="form-control" />
								</div>
								<div class="form-check mb-3">
									<input class="form-check-input" type="checkbox" id="itemEliminado" name="eliminado" />
									<label class="form-check-label" for="itemEliminado">Eliminado</label>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							<button type="button" id="cancelItem" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="button" class="btn btn-primary" id="saveItem">Guardar</button>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div th:replace="~{components/header :: scripts}"></div>

		<script>
			(function(){
				var modalEl = document.getElementById('abmModal');
				var abmModal = modalEl ? new bootstrap.Modal(modalEl) : null;
				function clearForm(){
					document.getElementById('itemId').value=''; document.getElementById('itemMes').value=''; document.getElementById('itemAnio').value=''; document.getElementById('itemFechaV').value=''; document.getElementById('itemValor').value=''; document.getElementById('itemEstado').value=''; document.getElementById('itemEliminado').checked=false;
				}
				document.getElementById('btnNew').addEventListener('click', function(){ clearForm(); document.getElementById('abmModalTitle').textContent='Nueva Cuota'; abmModal.show(); });
				document.querySelectorAll('.btn-edit').forEach(function(btn){ btn.addEventListener('click', function(){ document.getElementById('itemId').value=btn.getAttribute('data-id'); document.getElementById('itemMes').value=btn.getAttribute('data-mes'); document.getElementById('itemAnio').value=btn.getAttribute('data-anio'); document.getElementById('itemFechaV').value=btn.getAttribute('data-fechav'); document.getElementById('itemValor').value=btn.getAttribute('data-valor'); document.getElementById('itemEstado').value=btn.getAttribute('data-estado'); document.getElementById('itemEliminado').checked = btn.getAttribute('data-eliminado') === 'true'; document.getElementById('abmModalTitle').textContent='Editar Cuota'; abmModal.show(); }); });
				document.querySelectorAll('.btn-delete').forEach(function(btn){ btn.addEventListener('click', function(){ var id=btn.getAttribute('data-id'); if(confirm('¿Eliminar cuota #'+id+'?')) btn.closest('tr').remove(); }); });
				document.getElementById('saveItem').addEventListener('click', function(){ abmModal.hide(); }); var cancelBtn = document.getElementById('cancelItem'); if(cancelBtn) cancelBtn.addEventListener('click', function(){ if(abmModal) abmModal.hide(); });
			})();
		</script>

	</body>
</html>
