<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
	<head th:replace="~{components/header :: head}"></head>
	<body>

		<!-- Reuse admin navbar -->
		<div th:replace="~{components/admin_subnav :: admin_nav}"></div>

		<div class="container py-5" th:with="entityName='Empresas', items=${items}">
			<div class="d-flex justify-content-between align-items-center mb-4">
				<h2>ABM Empresas</h2>
				<div>
					<button class="btn btn-success" id="btnNew">Nuevo Empresa</button>
					<a class="btn btn-secondary" th:href="@{/portal/admin}">Volver al portal</a>
				</div>
			</div>

			<div class="table-responsive">
				<table class="table table-striped table-hover" id="abmTable">
					<thead>
						<tr>
							<th style="width:80px">#</th>
							<th>Nombre</th>
							<th>Teléfono</th>
							<th>Correo</th>
							<th>Eliminado</th>
							<th style="width:160px">Acciones</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="item : ${items}">
							<td th:text="${item.id}">id</td>
							<td th:text="${item.nombre}">Nombre</td>
							<td th:text="${item.telefono}">Telefono</td>
							<td th:text="${item.correoElectronico}">correo@ejemplo.com</td>
							<td><span th:text="${item.eliminado} ? 'Sí' : 'No'">No</span></td>
							<td>
								<button class="btn btn-sm btn-primary btn-edit" type="button"
												th:data-id="${item.id}" th:data-nombre="${item.nombre}" th:data-telefono="${item.telefono}" th:data-correo="${item.correoElectronico}" th:data-eliminado="${item.eliminado}">Editar</button>
								<button class="btn btn-sm btn-danger btn-delete" type="button" th:data-id="${item.id}">Eliminar</button>
							</td>
						</tr>
						<tr th:if="${items == null or #lists.isEmpty(items)}">
							<td colspan="6" class="text-center">No hay empresas cargadas.</td>
						</tr>
					</tbody>
				</table>
			</div>

			<!-- Modal: create/edit Empresa -->
			<div class="modal fade" id="abmModal" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="abmModalTitle">Nuevo Empresa</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<form id="abmForm">
								<input type="hidden" id="itemId" name="id" />
								<div class="mb-3">
									<label class="form-label">Nombre</label>
									<input id="itemNombre" name="nombre" class="form-control" required />
								</div>
								<div class="mb-3">
									<label class="form-label">Teléfono</label>
									<input id="itemTelefono" name="telefono" class="form-control" />
								</div>
								<div class="mb-3">
									<label class="form-label">Correo Electrónico</label>
									<input id="itemCorreo" name="correoElectronico" class="form-control" type="email" />
								</div>
								<div class="form-check mb-3">
									<input class="form-check-input" type="checkbox" id="itemEliminado" name="eliminado" />
									<label class="form-check-label" for="itemEliminado">Eliminado</label>
								</div>
							</form>
						</div>
						<div class="modal-footer">
							  <button type="button" id="cancelItem" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
							<button type="button" class="btn btn-primary" id="saveItem">Guardar</button>
						</div>
					</div>
				</div>
			</div>

		</div>

		<div th:replace="~{components/header :: scripts}"></div>

		<script>
			(function(){
				var modalEl = document.getElementById('abmModal');
				var abmModal = modalEl ? new bootstrap.Modal(modalEl) : null;

				function clearForm(){
					document.getElementById('itemId').value = '';
					document.getElementById('itemNombre').value = '';
					document.getElementById('itemTelefono').value = '';
					document.getElementById('itemCorreo').value = '';
					document.getElementById('itemEliminado').checked = false;
				}

				document.getElementById('btnNew').addEventListener('click', function(){
					clearForm();
					document.getElementById('abmModalTitle').textContent = 'Nuevo Empresa';
					abmModal.show();
				});

				document.querySelectorAll('.btn-edit').forEach(function(btn){
					btn.addEventListener('click', function(){
						document.getElementById('itemId').value = btn.getAttribute('data-id');
						document.getElementById('itemNombre').value = btn.getAttribute('data-nombre');
						document.getElementById('itemTelefono').value = btn.getAttribute('data-telefono');
						document.getElementById('itemCorreo').value = btn.getAttribute('data-correo');
						document.getElementById('itemEliminado').checked = btn.getAttribute('data-eliminado') === 'true';
						document.getElementById('abmModalTitle').textContent = 'Editar Empresa';
						abmModal.show();
					});
				});

				document.querySelectorAll('.btn-delete').forEach(function(btn){
					btn.addEventListener('click', function(){
						var id = btn.getAttribute('data-id');
						if (confirm('¿Eliminar empresa #' + id + '?')){
							// TODO: call backend to delete
							btn.closest('tr').remove();
						}
					});
				});

						document.getElementById('saveItem').addEventListener('click', function(){
							// TODO: send form via AJAX to backend (POST/PUT)
							abmModal.hide();
						});

						// Ensure Cancel closes modal even if bootstrap's data-api doesn't attach (defensive)
						var cancelBtn = document.getElementById('cancelItem');
						if (cancelBtn) {
							cancelBtn.addEventListener('click', function(){
								if (abmModal) abmModal.hide();
							});
						}
			})();
		</script>

</html>
