<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Detalle del Vehículo | MyCar</title>

  <!-- Fuentes y estilos -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Nunito', sans-serif;
      background-color: #f7f9fc;
      color: #333;
    }

    /* Navbar */
    header {
      background: #007bff;
      color: white;
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 24px;
      font-weight: 700;
    }

    header .logo i {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px;
      border-radius: 50%;
    }

    header nav a {
      color: white;
      text-decoration: none;
      margin-left: 16px;
      padding: 8px 16px;
      border-radius: 8px;
      transition: background 0.3s;
      font-weight: 600;
    }

    header nav a:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Contenedor principal */
    .container {
      max-width: 1100px;
      margin: 32px auto;
      padding: 0 24px;
    }

    h1 {
      font-size: 28px;
      color: #007bff;
      margin-bottom: 24px;
      text-align: center;
    }

    /* Tarjeta del vehículo */
    .vehicle-card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }

    .vehicle-img {
      flex: 1 1 380px;
      max-width: 420px;
      border-radius: 12px;
      overflow: hidden;
      background: #f4f4f4;
    }

    .vehicle-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .vehicle-info {
      flex: 1 1 360px;
    }

    dl {
      margin-bottom: 16px;
    }

    dt {
      font-weight: 700;
      color: #007bff;
      margin-top: 8px;
    }

    dd {
      margin-left: 0;
      margin-bottom: 8px;
    }

    /* Sección de reserva */
    .reservation-panel {
      border-top: 1px solid #e0e0e0;
      padding-top: 16px;
      margin-top: 16px;
    }

    .reservation-panel h3 {
      color: #007bff;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .date-row label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 0.9rem;
    }

    input[type="date"] {
      padding: 8px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="date"]:focus {
      border-color: #007bff;
      outline: none;
    }

    .btn {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #0056b3;
    }

    .btn-disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }

    #availabilityMsgDetail {
      font-weight: 600;
      margin-top: 6px;
    }

    @media (max-width: 768px) {
      .vehicle-card {
        flex-direction: column;
        align-items: center;
      }
      .vehicle-img {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <header>
    <div class="logo">
      <i class="fas fa-car"></i> MyCar
    </div>
    <nav>
      <a th:href="@{/vehiculos}">Vehículos</a>
      <a th:href="@{/perfil}">Perfil</a>
    </nav>
  </header>

  <div class="container">
    <h1>Detalle del Vehículo</h1>

    <div th:if="${vehiculo != null}" th:object="${vehiculo}" class="vehicle-card" th:attr="data-vehicle-id=${vehiculo.id}">
      <div class="vehicle-img">
        <img th:if="${vehiculo.caracteristicaVehiculo.imagenVehiculo != null and vehiculo.caracteristicaVehiculo.imagenVehiculo.base64 != null}"
             th:src="${vehiculo.caracteristicaVehiculo.imagenVehiculo.base64}" alt="Vehículo" />
        <img th:if="${vehiculo.caracteristicaVehiculo.imagenVehiculo == null}"
             th:src="@{/img/placeholder.jpg}" alt="Sin imagen" />
      </div>

      <div class="vehicle-info">
        <dl>
          <dt>Patente</dt>
          <dd th:text="*{patente}">ABC123</dd>

          <dt>Estado</dt>
          <dd th:text="*{estadoVehiculo}">DISPONIBLE</dd>

          <dt>Marca</dt>
          <dd th:text="*{caracteristicaVehiculo.marca}">Toyota</dd>

          <dt>Modelo</dt>
          <dd th:text="*{caracteristicaVehiculo.modelo}">Corolla</dd>

          <dt>Año</dt>
          <dd th:text="*{caracteristicaVehiculo.anio}">2022</dd>

          <dt>Asientos</dt>
          <dd th:text="*{caracteristicaVehiculo.cantidadAsiento}">5</dd>

          <dt>Puertas</dt>
          <dd th:text="*{caracteristicaVehiculo.cantidadPuerta}">4</dd>
        </dl>

        <div class="reservation-panel">
          <h3><i class="fas fa-calendar-check"></i> Reservar</h3>

          <div class="date-row">
            <label>Desde
              <input type="date" id="fechaDesdeDetail" />
            </label>
            <label>Hasta
              <input type="date" id="fechaHastaDetail" />
            </label>
          </div>

          <p>Precio por día: <strong id="basePriceDetail" th:text="${vehiculo.caracteristicaVehiculo.costoVehiculo.costo}">0</strong></p>
          <p>Total: <strong id="totalPriceDetail">-</strong></p>
          <p id="availabilityMsgDetail">Elige fechas para comprobar disponibilidad.</p>

          <button id="reserveBtnDetail" class="btn btn-disabled" disabled>Reservar</button>
        </div>
      </div>
    </div>
  </div>

 <script>
// Detail page: date pickers compute price and check availability for this vehicle
function daysBetweenInclusive(fromStr, toStr) {
        const from = new Date(fromStr);
        const to = new Date(toStr);
        // Normalize time portion to avoid DST issues
        from.setHours(0,0,0,0);
        to.setHours(0,0,0,0);
        const diff = to - from;
        if (isNaN(diff)) return NaN;
        return Math.floor(diff / (1000*60*60*24)) + 1; // inclusive
}

function formatMoney(v){
        if (v == null || isNaN(v)) return '-';
        return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits:0 }).format(v);
}

async function checkAvailabilityForVehicle(vehicleId, desde, hasta){
        // Call the controller endpoint that validates params and delegates to service
        // VehiculoController.available expects: fechaDesde, fechaHasta, id
        const url = `/vehiculos/available?fechaDesde=${encodeURIComponent(desde)}&fechaHasta=${encodeURIComponent(hasta)}&id=${encodeURIComponent(vehicleId)}`;
        const resp = await fetch(url, { credentials: 'same-origin' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const body = await resp.json();
        // backend returns a boolean (true/false)
        if (typeof body === 'boolean') return body;
        // if backend wraps in object { available: true }
        if (body && typeof body.available === 'boolean') return body.available;
        // if backend returns list of ids, check inclusion
        if (Array.isArray(body)) {
                return body.some(v => (v.id || v) == vehicleId);
        }
        return false;
}

document.addEventListener('DOMContentLoaded', ()=>{
        const card = document.querySelector('[data-vehicle-id]');
        if (!card) return;
        const vehicleId = card.getAttribute('data-vehicle-id');
        const desdeEl = document.getElementById('fechaDesdeDetail');
        const hastaEl = document.getElementById('fechaHastaDetail');
        const basePriceEl = document.getElementById('basePriceDetail');
        const totalEl = document.getElementById('totalPriceDetail');
        const availMsg = document.getElementById('availabilityMsgDetail');
        const reserveBtn = document.getElementById('reserveBtnDetail');

        const basePrice = parseFloat(basePriceEl ? basePriceEl.textContent.trim() : 0) || 0;

        async function onDateChange(){
                const desde = desdeEl.value;
                const hasta = hastaEl.value;
                totalEl.textContent = '-';
                availMsg.textContent = 'Elige fechas para comprobar disponibilidad.';
                reserveBtn.disabled = true;

                if (!desde || !hasta) return;
                const days = daysBetweenInclusive(desde, hasta);
                if (!isFinite(days) || days <= 0) {
                        availMsg.textContent = 'Rango de fechas inválido.';
                        availMsg.style.color = 'crimson';
                        reserveBtn.disabled = true;
                        reserveBtn.classList.add('btn-disabled');
                        return;
                }

                // Compute total using basePrice as price per day
                const total = basePrice * days;
                totalEl.textContent = formatMoney(total);

                // Check availability via backend
                try{
                        availMsg.textContent = 'Comprobando disponibilidad...';
                        const available = await checkAvailabilityForVehicle(vehicleId, desde, hasta);
                        if (available) {
                                availMsg.style.color = 'green';
                                availMsg.textContent = `Disponible ${days} día(s)`;
                                reserveBtn.disabled = false;
                                reserveBtn.classList.remove('btn-disabled');
                                // remove visual unavailable marker from card
                                //card.classList.remove('unavailable');
                        } else {
                                availMsg.style.color = 'crimson';
                                availMsg.textContent = 'No disponible en esas fechas.';
                                reserveBtn.disabled = true;
                                reserveBtn.classList.add('btn-disabled');
                                // visually mark the card as unavailable
                                //card.classList.add('unavailable');
                        }
                } catch(err){
                        console.error('Error checking availability', err);
                        availMsg.style.color = 'crimson';
                        availMsg.textContent = 'Error al comprobar disponibilidad';
                        reserveBtn.disabled = true;
                        reserveBtn.classList.add('btn-disabled');
                        // visually mark the card as unavailable
                        //card.classList.add('unavailable');
                }
        }

        desdeEl.addEventListener('change', onDateChange);
        hastaEl.addEventListener('change', onDateChange);

        reserveBtn.addEventListener('click', ()=>{
                const desde = desdeEl.value;
                const hasta = hastaEl.value;
                if (!desde || !hasta) return alert('Seleccione rango válido');
                // compute inclusive days and total so we can pass them to the alquiler form
                const days = daysBetweenInclusive(desde, hasta);
                if (!isFinite(days) || days <= 0) return alert('Rango de fechas inválido');
                const total = Math.round((basePrice || 0) * days);
                // Redirect to alquiler detail page with query params (the template reads ${param.*})
                const url = '/alquiler/detail'
                        + '?id=' + encodeURIComponent(vehicleId)
                        + '&fechaDesde=' + encodeURIComponent(desde)
                        + '&fechaHasta=' + encodeURIComponent(hasta)
                        + '&basePrice=' + encodeURIComponent(basePrice || 0)
                        + '&total=' + encodeURIComponent(total);
                window.location.href = url;
        });
});
</script>
<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
    <script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/vendor/jquery-easing/jquery.easing.min.js}"></script>
    <script th:src="@{/js/sb-admin-2.min.js}"></script>
</body>
</html>
